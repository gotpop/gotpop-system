name: Type Check

on:
  push:
    branches: [master]
    paths: ['packages/**']
  pull_request:
    branches: [master]
    paths: ['packages/**']
  workflow_dispatch:

jobs:
  type-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Create blog-like environment for type checking
        run: |
          # Create a temporary Next.js project that mimics gotpop-blog setup
          mkdir -p /tmp/type-check-env
          cd /tmp/type-check-env
          
          # Initialize with same dependencies as gotpop-blog (exact versions)
          npm init -y
          npm install --legacy-peer-deps \
            next@16.0.0 \
            react@19.2.0 \
            react-dom@19.2.0 \
            typescript@^5 \
            "@types/node@^20" \
            "@types/react@19.2.2" \
            "@types/react-dom@19.2.2" \
            "@storyblok/react@^5.4.17" \
            "react-icons@^5.5.0" \
            "server-only@^0.0.1" \
            "storyblok-rich-text-react-renderer@^3.0.1"

      - name: Copy package source and create blog-like tsconfig
        run: |
          cd /tmp/type-check-env
          
          # Copy the package source
          cp -r $GITHUB_WORKSPACE/packages/server/src ./src
          
          # Create tsconfig that matches gotpop-blog exactly
          cat > tsconfig.json << 'EOF'
          {
            "compilerOptions": {
              // Modern module resolution (matches @gotpop/server package)
              "moduleResolution": "bundler",
              "allowSyntheticDefaultImports": true,
              "esModuleInterop": true,
              "skipLibCheck": true,
              
              // React & JSX (matches @gotpop/server package)
              "jsx": "react-jsx",
              "jsxImportSource": "react",
              
              // Module system (matches @gotpop/server package)
              "module": "ESNext",
              "target": "ES2020",
              "lib": ["ES2020", "DOM", "DOM.Iterable"],
              
              // Type checking (matches @gotpop/server package)
              "strict": true,
              "noUnusedLocals": false,
              "noUnusedParameters": false,
              "exactOptionalPropertyTypes": false,
              
              // Next.js specific
              "noEmit": true,
              "incremental": true,
              "plugins": [{ "name": "next" }],
              "isolatedModules": true,
              
              // Resolution (matches @gotpop/server package)
              "resolveJsonModule": true,
              "allowJs": true,
              "forceConsistentCasingInFileNames": true,
              
              // Path mappings for blog-like setup
              "baseUrl": ".",
              "paths": {
                "@/*": ["./src/*"],
                "@/components/*": ["./src/components/*"],
                "@/icons": ["./src/components/icons"],
                "@/icons/*": ["./src/components/icons/*"],
                "@/lib/*": ["./src/lib/*"],
                "@/storyblok": ["./src/components/storyblok"],
                "@/storyblok/*": ["./src/components/storyblok/*"],
                "@/styles/*": ["./src/styles/*"],
                "@/types/*": ["./src/types/*"],
                "@/ui/*": ["./src/components/ui/*"],
                "@/utils/*": ["./src/utils/*"]
              },
              
              // Node.js types (matches @gotpop/server package)
              "types": ["node"]
            },
            "include": [
              "next-env.d.ts",
              "global.d.ts",
              "src/types/css-raw.d.ts",
              "**/*.ts",
              "**/*.tsx"
            ],
            "exclude": [
              "node_modules",
              "**/*.test.*",
              "**/*.spec.*",
              "**/*.stories.*"
            ]
          }
          EOF

      - name: Create missing type declarations (blog environment)
        run: |
          cd /tmp/type-check-env
          
          # Create next-env.d.ts (critical for Next.js types)
          cat > next-env.d.ts << 'EOF'
          /// <reference types="next" />
          /// <reference types="next/image-types/global" />

          // NOTE: This file should not be edited
          // see https://nextjs.org/docs/basic-features/typescript for more information.
          EOF
          
          # Create css-raw types (from blog)
          mkdir -p src/types
          cat > src/types/css-raw.d.ts << 'EOF'
          declare module "*.css" {
            const content: string;
            export default content;
          }
          EOF
          
          # Create global type declarations that include custom elements
          cat > global.d.ts << 'EOF'
          import type { DetailedHTMLProps, HTMLAttributes, ButtonHTMLAttributes } from "react"

          declare global {
            namespace JSX {
              interface IntrinsicElements {
                "box-grid": DetailedHTMLProps<HTMLAttributes<HTMLDivElement>, HTMLDivElement> & {
                  "auto-columns"?: boolean;
                };
                "box-crosshatch": DetailedHTMLProps<HTMLAttributes<HTMLDivElement>, HTMLDivElement>;
                "baseline-status": DetailedHTMLProps<HTMLAttributes<HTMLDivElement>, HTMLDivElement> & {
                  "data-status"?: string;
                };
                "link-list": DetailedHTMLProps<HTMLAttributes<HTMLDivElement>, HTMLDivElement>;
                "logo-main": DetailedHTMLProps<HTMLAttributes<HTMLDivElement>, HTMLDivElement>;
                "main-content": DetailedHTMLProps<HTMLAttributes<HTMLElement>, HTMLElement>;
                "code-block": DetailedHTMLProps<HTMLAttributes<HTMLDivElement>, HTMLDivElement>;
                "snippet-block": DetailedHTMLProps<HTMLAttributes<HTMLDivElement>, HTMLDivElement>;
                "button-toggle": DetailedHTMLProps<ButtonHTMLAttributes<HTMLButtonElement>, HTMLButtonElement>;
                "icon-hamburger": DetailedHTMLProps<HTMLAttributes<HTMLDivElement>, HTMLDivElement>;
                "page-layout": DetailedHTMLProps<HTMLAttributes<HTMLDivElement>, HTMLDivElement>;
              }
            }
          }

          // Fix react-icons types to include className
          declare module "react-icons/lib" {
            import { ComponentType } from "react"
            
            export interface IconBaseProps {
              children?: React.ReactNode;
              size?: string | number;
              color?: string;
              title?: string;
              className?: string;
              style?: React.CSSProperties;
              attr?: React.SVGAttributes<SVGElement>;
            }
            
            export type IconType = ComponentType<IconBaseProps>;
          }

          export {}
          EOF

      - name: Run TypeScript type checking
        run: |
          cd /tmp/type-check-env
          
          # Debug: Check React version and type definitions
          echo "=== React version ==="
          npm list react @types/react
          
          echo "=== TypeScript config ==="
          cat tsconfig.json
          
          echo "=== Running type check ==="
          npx tsc --noEmit --pretty

      - name: Show type check results
        run: |
          echo "âœ… Type checking completed successfully!"
          echo "Package source is compatible with Next.js + React 19 environment"